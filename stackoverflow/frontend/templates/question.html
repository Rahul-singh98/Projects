{% extends 'base.html' %}
{% block main %}
<div class="container">
    {% load static %}
    {% include 'assist/ask_question_temp.html' %}
    <h2>{{ question.title }}</h2>
    <div class="row">
        <div class="col text-secondary"><small>Asked {{ question.entity.creationDateTime | timesince }} ago</small>
        </div>
    </div>
    <hr>
    <div class="row">
        <div class="col-2">
            <div class="row-sm">
                {% if votes_ud == 0 %}                
                    <img class="upvote selected" src="/static/images/upvote-on.svg" alt="upvote" width="20px" height="20px">
                {% else %}
                    <img class="upvote" src="/static/images/upvote-off.svg" alt="upvote" width="20px" height="20px">
                {% endif %}
            </div>
            <div class="row">
                <p class="mt-1 mb-1">{{ question.views | title }}</p>
            </div>
            <div class="row-sm">
                {% if votes_ud == 1 %}
                    <img class="downvote selected" src="/static/images/downvote-on.svg" alt="downvote" width="20px" height="20px">
                {% else %}
                    <img class="downvote" src="/static/images/downvote-off.svg" alt="downvote" width="20px" height="20px">
                {% endif %}
            </div>
        </div>
        <div class="col-10">
            {{ question.entity.text | safe }}
        </div>
    </div>

    <form action="{% url 'comment' question.id %}" method="POST">
        {% csrf_token %}
        <div class="mt-5" style="max-height: 200px;">
            <textarea name="comment" id="comment" height="100px"></textarea>
            <div class="d-flex justify-content-end my-3">
                <input type="submit" class="btn btn-outline-primary" value="Comment">
            </div>
        </div>
    </form>

    <form action="{% url 'answer' question.id %}" method="POST">
        {% csrf_token %}
        <div class="mt-5">
            <textarea name="answer" id="answer" cols="30" rows="5"></textarea>
            <div class="d-flex justify-content-end my-3">
                <input type="submit" class="form-control btn btn-outline-primary" value="Answer">
            </div>
        </div>
    </form>

    {% for cmnt in question.getComments %}
    <div class="row">
        <h3>Comment</h3>
        <div class="col-2">
            <a href="{% url 'profile' cmnt.entity.creator.id %}" class="btn btn-outline-primary btn-sm px-3">
                {{ cmnt.entity.creator.username }}</a>
            <small>{{ cmnt.entity.creationDateTime | timesince }} ago</small>
        </div>
        <div class="col-10">
            <p>{{ cmnt.entity.text | safe }}</p>
        </div>
    </div>
    <hr>
    {% endfor %}


    {% for ans in question.getAnswers %}
    <div class="row">
        <h3>Answer</h3>
        <div class="col-2">
            <a href="{% url 'profile' ans.entity.creator.id %}" class="btn btn-outline-primary btn-sm px-3">
                {{ ans.entity.creator.username }}</a>
            <small>{{ ans.entity.creationDateTime | timesince }} ago</small>
        </div>
        <div class="col-10">
            <p>{{ ans.entity.text | safe }}</p>
        </div>
    </div>
    <hr>
    {% endfor %}


</div>
<script src="{% static 'js/WYSIWYG.js' %}"></script>
<script>
    $(document).ready(function() {
        $('img.upvote').click(function () {
            var id = '{{ question.id }}';
            var vote_type = 'up';

            if ($(this).hasClass('selected')) {
                var vote_action = 'recall-vote'
                $.post('/question/vote', { id: id, type: vote_type, action: vote_action, csrfmiddlewaretoken: '{{ csrf_token }}'}, function (response) {
                    console.log(response)
                    if (Number.isInteger(response)) {
                        $('img.upvote').removeAttr('src')
                            .attr('src', '/static/images/upvote-off.svg')
                            .removeClass('selected');
                    }
                });
            } else {
                var vote_action = 'vote'
                $.post('/question/vote', { id: id, type: vote_type, action: vote_action, csrfmiddlewaretoken: '{{ csrf_token }}'}, function (response) {
                    console.log(response)
                    if (Number.isInteger(response)) {
                        $('img.upvote').removeAttr('src')
                            .attr('src', '/static/images/upvote-on.svg')
                            .addClass('selected')
                    }
                });
            }
        })

        $('img.downvote').click(function () {
            var id = '{{ question.id }}';
            var vote_type = 'up';

            if ($(this).hasClass('selected')) {
                var vote_action = 'recall-vote'
                $.post('/question/vote', { id: id, type: vote_type, action: vote_action, csrfmiddlewaretoken: '{{ csrf_token }}'}, function (response) {
                    console.log(response)
                    if (Number.isInteger(response)) {
                        $('img.downvote').removeAttr('src')
                            .attr('src', '/static/images/downvote-off.svg')
                            .removeClass('selected');
                    }
                });
            } else {
                var vote_action = 'vote'
                $.post('/question/vote', { id: id, type: vote_type, action: vote_action, csrfmiddlewaretoken: '{{ csrf_token }}'}, function (response) {
                    console.log(response)
                    if (Number.isInteger(response)) {
                        $('img.downvote').removeAttr('src')
                            .attr('src', '/static/images/downvote-on.svg')
                            .addClass('selected')
                    }
                });
            }
        })
    });
</script>
{% endblock %}